ReportLink:https://hackerone.com/reports/142135
WeaknessName:Cross-site Scripting (XSS) - Generic
Reporter:https://hackerone.com/irek
ReportedTo:VK.com(vkcom)
BountyAmount:1500.0
Severity:
State:Closed
DateOfDisclosure:09.02.2017 14:20:44

Summary:

–î–æ–±—Ä—ã–π –≤–µ—á–µ—Ä!
–†–∞—Å–∫—Ä—É—Ç–∏–ª –∏–Ω—Ç–µ—Ä–µ—Å–Ω—É—é xss –Ω–∞ upload.php.

**–î–µ–º–æ [—Ç—É—Ç](https://vk.com/app5486273) –∏–ª–∏ [—Ç—É—Ç](https://irek.wtf/vk.com/transport/).**

–ö–∞–∫ –≤—Å–µ –±—ã–ª–æ?
–£–≤–∏–¥–µ–ª –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π —ç–∫—à–Ω [upload.php?act=transport](https://pu.vk.com/c415824/upload.php?act=transport&to_act=add_doc&hash=8dfd93e60c78ddb4a9cf914c27f7642c&rhash=8171a35e59a63aab65846a26345ddbf6&aid=1&mid=17274528&callback=getUploadSvg), –∫–æ—Ç–æ—Ä—ã–π —Å–ª—É–∂–∏—Ç –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Ä–∏—Å–æ–≤–∞–Ω–Ω–æ–≥–æ –≥—Ä–∞—Ñ—Ñ–∏—Ç–∏ –≤ –¥–æ–∫—É–º–µ–Ω—Ç—ã. –ì–ª–∞–∑ –∑–∞—Ü–µ–ø–∏–ª—Å—è –∑–∞ –≤—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ `eval` –≤ —Å—Ç—Ä–æ–∫–µ 25. –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä `callback`, –∑–Ω–∞—á–µ–Ω–∏–µ–º –∫–æ—Ç–æ—Ä–æ–≥–æ –≤ –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ —è–≤–ª—è–µ—Ç—Å—è —Å—Ç—Ä–æ–∫–∞ `getUploadSvg`.  –ù–∞ —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `sendData` (—Å—Ç—Ä–æ–∫–∏ 11-52) –∏, –ø–æ–º–∏–º–æ —ç—Ç–æ–≥–æ, –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Å–ª–µ–¥—É—é—â–∏–π –∫—É—Å–æ–∫ –∫–æ–¥–∞ (—Å—Ç—Ä–æ–∫–∏ 55-64):

    var _ua = navigator.userAgent;
    var locDomain = location.host.toString().match(/[a-zA-Z]+\.[a-zA-Z]+\.?$/)[0];
    if (/opera/i.test(_ua) || !/msie 6/i.test(_ua) || document.domain != locDomain) {
      document.domain = locDomain;
    }
    if (window.parent) {
      parent.getUploadSvg(function(data) {
        sendData('/c415824/upload.php?transport=iframe&act=add_doc&hash=8dfd93e60c78ddb4a9cf914c27f7642c&rhash=8171a35e59a63aab65846a26345ddbf6&aid=1&mid=17274528&pda=', data);
      });
    }

, –≥–¥–µ –µ—Å—Ç—å –¥–≤–∞ —É—Å–ª–æ–≤–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ —Å –±–µ—Å—Å–º—ã—Å–ª–µ–Ω–Ω—ã–º–∏ —É—Å–ª–æ–≤–∏—è–º–∏ üë≥üèæ. –í –ø–µ—Ä–≤–æ–º –ø—Ä–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è `document.domain` –¥–ª—è –∫—Ä–æ—Å—Å–¥–æ–º–µ–Ω–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤, –∞ –≤–æ –≤—Ç–æ—Ä–æ–º –≤—Å–µ —Å–∞–º–æ–µ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–µ - –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —Ñ—É–Ω–∫—Ü–∏—è —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –æ–∫–Ω–∞ `parent.getUploadSvg`, –≥–¥–µ `getUploadSvg` —ç—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ GET-–ø–∞—Ä–∞–º–µ—Ç—Ä–∞ `callback` ~~(–∫–∞–∫ —É–∂–µ –±—ã–ª–æ –Ω–∞–ø–∏—Å–∞–Ω–æ –≤—ã—à–µ)~~ –∏ –µ–≥–æ –∑–Ω–∞—á–µ–Ω–∏–µ –º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å –Ω–∞ –ª—é–±–æ–µ –¥—Ä—É–≥–æ–µ (–ø—Ä–µ–¥–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ –ø–æ–¥—Ö–æ–¥—è—â–µ–µ –ø–æ–¥ –ø–∞—Ç—Ç–µ—Ä–Ω `/^[a-zA-Z0-9]*$/`). –¢–æ –µ—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏ `parent.{–∑–Ω–∞—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ callback}` –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –æ–¥–∏–Ω –∞—Ä–≥—É–º–µ–Ω—Ç, —è–≤–ª—è—é—â–∏–π—Å—è –∞–Ω–æ–Ω–∏–º–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–µ–π. –≠—Ç–∞ –∞–Ω–æ–Ω–∏–º–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –æ–¥–∏–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä `data`, –∞ –≤ –µ—ë —Ç–µ–ª–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ `sendData` (—Å—Ç—Ä–æ–∫–∞ 62):

    sendData('/c415824/upload.php?transport=iframe&act=add_doc&hash=8dfd93e60c78ddb4a9cf914c27f7642c&rhash=8171a35e59a63aab65846a26345ddbf6&aid=1&mid=17274528&pda=', data);


–¢—É—Ç –ø–µ—Ä–≤—ã–π –∞—Ä–≥—É–º–µ–Ω—Ç —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞, —Å–æ–¥–µ—Ä–∂–∞—â–∞—è –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π URL, –≤ –∫–æ—Ç–æ—Ä—ã–π –ø–æ–ø–∞–¥–∞—é—Ç –ø–æ—á—Ç–∏ –≤—Å–µ –∏—Å—Ö–æ–¥–Ω—ã–µ GET-–ø–∞—Ä–∞–º–µ—Ç—Ä—ã, –ø—Ä–æ—Ö–æ–¥—è –ø–µ—Ä–µ–¥ –≤—ã–≤–æ–¥–æ–º —Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—é. –í—Ç–æ—Ä–æ–π –ø–∞—Ä–∞–º–µ—Ç—Ä —ç—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è `data`, –æ –∫–æ—Ç–æ—Ä–æ–π –ø–∏—Å–∞–ª —á—É—Ç—å –≤—ã—à–µ.

–†–∞–∑–±–µ—Ä–µ–º —Å–∞–º—É —Ñ—É–Ω–∫—Ü–∏—é `sendData`. –û–Ω–∞ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ç—Ä–∏ –∞—Ä–≥—É–º–µ–Ω—Ç–∞ `url`, `file` –∏ `sequel `. –ü–æ –ø–æ–Ω—è—Ç–Ω—ã–º –ø—Ä–∏—á–∏–Ω–∞–º, –Ω–∞–º –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ –¥–≤–∞. –°—Ç–æ–∏—Ç –æ–±—Ä–∞—Ç–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ —Å—Ç—Ä–æ–∫—É 16

    var plain = /iphone|ipod|ipad|opera mini|opera mobi/i.test(navigator.userAgent);

–∏ –±–ª–æ–∫ –∫–æ–¥–∞ —É—Å–ª–æ–≤–Ω–æ–≥–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –≤ —Å—Ç—Ä–æ–∫–∞—Ö 29-41

    if (plain) {
      xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
      xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');

      if (dataUrl.length > 15000) {
        fdataUrl = dataUrl.substr(0, 15000);
        ndataUrl = dataUrl.substr(15000);
        dataUrl = fdataUrl;
        more = 1;
      }

      xhr.send(ajx2q({Data: dataUrl, more: more, sequel: sequel || 0}));
    } else {

–û—Å—Ç–∞–Ω–æ–≤–∏–ª–∏—Å—å –º—ã –Ω–∞ —ç—Ç–æ–º –ø–æ—Ç–æ–º—É, —á—Ç–æ –≤ —Å—Ç—Ä–æ–∫–µ 40 –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ `ajx2q `, –∫–æ—Ç–æ—Ä–∞—è –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –∏, –ø–æ—ç—Ç–æ–º—É, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≥—Ä–∞—Ñ—Ñ–∏—Ç–∏ –≤ –¥–æ–∫—É–º–µ–Ω—Ç—ã –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è —é–∑–µ—Ä–∞–≥–µ–Ω—Ç–æ–≤ —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—è—é—â–∏—Ö —Ä–µ–≥—É–ª—è—Ä–Ω–æ–º—É –≤—ã—Ä–∞–∂–µ–Ω–∏—é `/iphone|ipod|ipad|opera mini|opera mobi/i`. –°–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –∏ —Ö–∞–∫ –Ω–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å. –ï—Å–ª–∏ –Ω–µ –æ–±—Ä–∞—â–∞—Ç—å –≤–Ω–∏–º–∞–Ω–∏—è –Ω–∞ —Å–µ–π –¥–æ—Å–∞–¥–Ω—ã–π —Ñ–∞–∫—Ç, —Ç–æ –º–æ–∂–Ω–æ –∑–∞–º–µ—Ç–∏—Ç—å, —á—Ç–æ –≤ —Ñ—É–Ω–∫—Ü–∏–∏ `sendData` —Å –ø–æ–º–æ—â—å—é `XMLHttpRequest` –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç POST-–∑–∞–ø—Ä–æ—Å –Ω–∞ URL, –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –∫–æ—Ç–æ—Ä–æ–≥–æ –º—ã –º–æ–∂–µ–º –º–∞–Ω–∏–ø—É–ª–∏—Ä–æ–≤–∞—Ç—å. –í —Å–ª—É—á–∞–µ —É—Å–ø–µ—Ö–∞, —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–ø—Ä–æ—Å–∞ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ —Ñ—É–Ω–∫—Ü–∏—é `eval`, —á—Ç–æ –∫—Ä—É—Ç–æ –µ—Å–ª–∏ –∫–∞–∫–∏–º-—Ç–æ –æ–±—Ä–∞–∑–æ–º –∑–∞—Å—Ç–∞–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä –≤—ã–¥–∞–≤–∞—Ç—å –Ω—É–∂–Ω—ã–π –Ω–∞–º –æ—Ç–≤–µ—Ç –Ω–∞ —ç—Ç–æ—Ç POST-–∑–∞–ø—Ä–æ—Å. –ü–æ—Å–∫–æ–ª—å–∫—É –º—ã –º–æ–∂–µ–º –º–∞–Ω–∏–ø—É–ª–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ URL, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω –∑–∞–ø—Ä–æ—Å, —è –Ω–∞—á–∞–ª –¥—É–º–∞—Ç—å –Ω–∞–¥ —Ç–µ–º –∫–∞–∫ –∑–∞—Å—Ç–∞–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –∑–∞–ø—Ä–æ—Å –º–æ–∏–º js-–∫–æ–¥–æ–º. –¢—É—Ç —è –≤—Å–ø–æ–º–Ω–∏–ª –æ —Ç–æ–º, —á—Ç–æ —Å—É—â–µ—Å—Ç–≤—É—é—Ç —Ç–∞–∫–∏–µ —à—Ç—É–∫–∏ –∫–∞–∫ [imagejs](http://jklmnn.de/imagejs/) –∏ [share.php](https://vk.com/share.php?url=https://irek.wtf/shareit.php). –ü–µ—Ä–≤–æ–µ –Ω–∞–º –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ –ø–æ—Ç–æ–º—É —á—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤—Å—Ç—Ä–æ–∏—Ç—å js-–∫–æ–¥ –ø—Ä—è–º–æ —Ñ–∞–π–ª—ã –∫–∞—Ä—Ç–∏–Ω–æ–∫ (Gif, Bitmap, WebP, Netbpm Anymap, Progressive Graphics) –∏ —Ñ–∞–π–ª—ã –±—É–¥—É—Ç –≤–∞–ª–∏–¥–Ω—ã. –ê –≤ share.php –∫–∞–∫-—Ä–∞–∑ –µ—Å—Ç—å –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π ([–ø—Ä–∏–º–µ—Ä](https://pu.vk.com/c539421/upload.php?act=proxy_img&url=https%3A%2F%2Firek.wtf%2Fpikachu.gif&hash=f5b4a65619ba2c63a7bb018db018bfce)). –¢—É—Ç —è —Å—Ç–æ–ª–∫–Ω—É–ª—Å—è —Å –¥—Ä—É–≥–æ–π –ø—Ä–æ–±–ª–µ–º–æ–π - —Ö—ç—à–∏. –≠—Ç–æ –±—ã–ª–∞ –±–æ–ª—å, –Ω–æ –º–µ—Ç–æ–¥–æ–º —Ç—ã–∫–∞ —è –ø–æ–Ω—è–ª, —á—Ç–æ –µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç—É `upload_fails.php` –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ –¥–æ–±–∞–≤–∏—Ç—å –∫ –Ω–∏–º `role=share`, —Ç–æ –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –≤–∞–ª–∏–¥–Ω—ã–µ —Ö—ç—à–∏, –∏—Å–ø–æ–ª—å–∑—É—è –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ —Å–∫—Ä–∞—Ñ—Ç–∏—Ç—å –∫–æ–Ω–µ—á–Ω—ã–π URL. –ù–∞ —ç—Ç–æ–º —ç—Ç–∞–ø–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞—Å—å –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å —Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏–∏ –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ (–ø—Ä–∏ –∏–∑—É—á–µ–Ω–∏–∏ –¥–µ–º–æ –æ–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ —Ç–æ—á–∫–∏ –≤ –Ω–∞–∑–≤–∞–Ω–∏—è—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤, –æ–Ω–∏ —Ç–∞–º –Ω–µ —Å–ª—É—á–∞–π–Ω–æ). –û—Å—Ç–∞–ª–æ—Å—å —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è —Å –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø—Ä–æ–±–ª–µ–º–æ–π. –ó–∞–∫–ª—é—á–∞–µ—Ç—Å—è –æ–Ω–∞ –≤ —Ç–æ–º, —á—Ç–æ `sendData` –ø—Ä–æ—Å—Ç–æ —Ç–∞–∫ –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è. –ù–∞–¥–æ –Ω–∞–π—Ç–∏ —Ç–∞–∫—É—é js-—Ñ—É–Ω–∫—Ü–∏—é, –¥–ª—è –∫–æ—Ç–æ—Ä–æ–π –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è —Å–ª–µ–¥—É—é—â–∏–µ —É—Å–ª–æ–≤–∏—è:

* –Ω–∞–∑–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ç–µ —Å–∏–º–≤–æ–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –ø–µ—Ä–µ–¥–∞—Ç—å —á–µ—Ä–µ–∑ GET-–ø–∞—Ä–∞–º–µ—Ç—Ä `callback` –∏ —Ñ—É–Ω–∫—Ü–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≥–ª–æ–±–∞–ª—å–Ω–æ–π;
* —Ñ—É–Ω–∫—Ü–∏—è –¥–æ–ª–∂–Ω–∞ –ø—Ä–∏–Ω–∏–º–∞—Ç—å –≤ –∫–∞—á–µ—Å—Ç–≤–µ –∞—Ä–≥—É–º–µ–Ω—Ç–∞ –¥—Ä—É–≥—É—é callback-—Ñ—É–Ω–∫—Ü–∏—é –∏ –≤—ã–∑–≤–∞—Ç—å –µ—ë –ø–µ—Ä–µ–¥–∞–≤–∞—è –≤ –∫–∞—á–µ—Å—Ç–≤–µ –∞—Ä–≥—É–º–µ–Ω—Ç–∞ –∫–∞–∫–æ–π-–Ω–∏–±—É–¥—å –æ–±—ä–µ–∫—Ç.

–ù–µ–º–Ω–æ–≥–æ `for (... in window)` –∏ —Ç–∞–∫–∞—è —Ñ—É–Ω–∫—Ü–∏—è –±—ã–ª–∞ –Ω–∞–π–¥–µ–Ω–∞ - `requestAnimationFrame` ([–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è](https://developer.mozilla.org/ru/docs/DOM/window.requestAnimationFrame)).

–î–∞–ª–µ–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–ª –¥–µ–º–æ, –∫–æ—Ç–æ—Ä–æ–µ –º–æ–∂–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å [—Ç—É—Ç](https://vk.com/app5486273) –∏–ª–∏ [—Ç—É—Ç](https://irek.wtf/vk.com/transport/). –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è `alert(document.cookie);`.

–¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, –ø–æ–ª—É—á–∏–ª–∏ xss –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–æ–≤, —Å—Ç—Ä–æ–∫–∞ user-agent –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ –ø–æ–ø–∞–¥–∞—é—Ç –ø–æ–¥ –ø–∞—Ç—Ç–µ—Ä–Ω `/iphone|ipod|ipad|opera mini|opera mobi/i` –∏ –≤ –∫–æ—Ç–æ—Ä—ã—Ö –∏–º–ø–ª–µ–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `requestAnimationFrame ` (–∏–ª–∏ —Å –≤–µ–Ω–¥–æ—Ä–Ω—ã–º–∏ –ø—Ä–µ—Ñ–∏–∫—Å–∞–º–∏ `mozRequestAnimationFrame`, `webkitRequestAnimationFrame`, `msRequestAnimationFrame`).